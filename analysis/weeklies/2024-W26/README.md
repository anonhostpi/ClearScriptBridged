Prior posts from this mini-series:

* Thanos Shauntlet: [https://www.reddit.com/r/PowerShell/comments/199i7nr/now\_presenting\_the\_thanos\_shauntlet/](https://www.reddit.com/r/PowerShell/comments/199i7nr/now_presenting_the_thanos_shauntlet/)
* Turning PowerShell Into A Python Engine: [https://www.reddit.com/r/PowerShell/comments/192uavr/turning\_powershell\_into\_a\_python\_engine/](https://www.reddit.com/r/PowerShell/comments/192uavr/turning_powershell_into_a_python_engine/)
* Turning PowerShell Into A JavaScript Engine: [https://www.reddit.com/r/PowerShell/comments/1937hkv/turning\_powershell\_into\_a\_javascript\_engine/](https://www.reddit.com/r/PowerShell/comments/1937hkv/turning_powershell_into_a_javascript_engine/)
* Working On Turning PowerShell Into A Node.JS Engine: [https://www.reddit.com/r/PowerShell/comments/1djdql5/working_on_turning_powershell_into_a_nodejs_engine/](https://www.reddit.com/r/PowerShell/comments/1djdql5/working_on_turning_powershell_into_a_nodejs_engine/)
  * **TL;DR: [_Github gist_](https://gist.github.com/anonhostpi/7ebc4007f3f51e0f255c2408d33b1781)**
* Turning PowerShell into Node.JS: Week 1 Progress: [https://www.reddit.com/r/PowerShell/comments/1dpg8i8/turning_powershell_into_nodejs_week_1_progress/](https://www.reddit.com/r/PowerShell/comments/1dpg8i8/turning_powershell_into_nodejs_week_1_progress/)
  * **TL;DR: [_Github gist_](https://gist.github.com/anonhostpi/njs-cjs-pwsh)**

# TL;DR:

```powershell
# I've reworked the structure of the project, and have given it a better name:
git clone https://github.com/anonhostpi/ClearScriptBridged.git
cd ClearScriptBridged
cd "analysis\weeklies\2024-W26"
. .\main.ps1

# $setup
# $paths

# $runtime
# $engine

# $dump
# $analysis
```

# Week 2: More on the importance of `internalBinding()`

OK, I finally have a good grasp on Node's binding system.

The more and more I dig into node.JS's internals, the more I am convinced that I only need to replicate a few Node APIs (bindings), then I can port _all of the internal nodeJS modules_ without much effort.

There are only a few exceptions to this rule. Most of the bound APIs (including the exceptions) are partially laid out in the node_builtins.cc file. The rest are laid out in each binding loaded by `internalBinding()` provided by the node_binding.cc file.

Both of these API types provide their own unique module type. Both sets can be parsed with the `process.moduleLoadList` array. The `moduleLoadList` array is a list of both `Internal Binding` modules loaded via `internalBinding()` and `NativeModule` (they are actually called `BuiltinModules`, but for legacy support they are listed as `NativeModules`) modules loaded via `compileForInternalLoader()` in the order they are loaded.

## node_builtins.cc and NativeModules/BuiltinModules

The node_builtins.cc binary is responsible for loading the _internal_ `NativeModule`/`BuiltinModule` JS files from node's C++ land with certain objects added as arguments.

There are 3 functions of importance in node_builtins.cc:
- `LookupAndCompile()` which wraps provided JS files in a function with a specified set of arguments. These arguments often include variables like `require`, `internalBinding`, and `primordials`.
- `CompileAndCall()` which calls the function returned by `LookupAndCompile()`. It is called by the main process.
- `CompileFunction()` which can be called from JS land to compile an internal js module using `LookupAndCompile()`.

### `LookupAndCompile()` and js2c.cc (formerly known as js2c.py)

`LookupAndCompile()` is a function that looksup an internal module and builds an associated callback/wrapper function with the contents of that module to be used by JS land's `compileFunction()` and C++ land's `CompileAndCall()`. `LookupAndCompile()` internally calls `BuiltinLoader::LoadBuiltinSource()` which parses the `BuiltinLoader::source_` source code map generated by the js2c.cc binary. 

js2c.cc is a utility for converting JavaScript source code into C-style char arrays. Think of it as creating a hashtable of filename keys paired to their source code as a string. The output of js2c.cc is a C++ file that is used to embed these modules into the node binary.
  - At compile time, the compiled js2c binary is fed the contents of lib/internal (I think it also maps the rest of lib/, but node's build files can be hard to follow) and outputs to a node_javascript.cc file to be compiled into the node binary.

## node_binding.cc and Internal Bindings

The node_binding.cc binary is responsible for providing the C++ backend to `internalBinding()`. `internalBinding()` is mapped to this C++ backend by node_builtins.cc and the lib/internal/bootstrap/realm.js files. Specifically, node_binding.cc provides a `GetInternalBinding()` function that is used by realm.js to generate `internalBinding()`, which is then fed back to node_builtins.cc via `setInternalLoaders()` to be used for the rest of the modules loaded via `LookupAndCompile()`.

Confusing, right? Here's an overview:

- _node_binding.cc_ sets `GetInternalBinding()` 
- _node_builtins.cc_ provides `GetInternalBinding()` to realm.js
- _realm.js_ defines `internalBinding()` using `GetInternalBinding()` 
- _realm.js_ sends `internalBinding()` to node_builtins.cc via `setInternalLoaders()` 
- _node_builtins.cc_ uses the new `internalBinding()` for the rest of the modules loaded via `LookupAndCompile()`
  - which is called by `CompileAndCall()` (C++ land) and `CompileFunction()` (JS land).

### `GetInternalBinding()` and `NODE_BINDING_CONTEXT_AWARE_INTERNAL()`

What `GetInternalBinding()` actually returns is an internal C++ NAPI module marked with the `NM_F_INTERNAL` flag. This flag is set by the `NODE_BINDING_CONTEXT_AWARE_INTERNAL()` macro that typically occurs at the end of that NAPI module's source code. The syntax of `NODE_BINDING_CONTEXT_AWARE_INTERNAL()` is as follows:

```c++
NODE_BINDING_CONTEXT_AWARE_INTERNAL(module_name, reg_func)
```

We're going to ignore the `reg_func` argument. To be honest it goes over my head. There are a few other macros that are used in conjunction with `NODE_BINDING_CONTEXT_AWARE_INTERNAL()` to expose specific APIs, but I currently don't have my head wrapped around them, just yet.

For now, I'm going to just generate a list of all instances of `NODE_BINDING_CONTEXT_AWARE_INTERNAL()` and what bindings they provide.:

#### Listing All Internal Bindings in Node.JS:

To do that, we need a search function.

```powershell
function Search-SourceFiles {
    param(
        [string] $SearchRoot = 'path/to/node/repo/src',
        [string[]] $FilePatterns = @('*.cc', '*.c'),
        [string] $Regex = 'NODE_BINDING_CONTEXT_AWARE_INTERNAL\(\s*(\S+)\s*,\s*\S+\s*\)'
    )

    # Check if path exists
    If (-not (Test-Path $SearchRoot)) {
        Throw "Path does not exist: $SearchRoot"
    }

    $files = New-Object System.Collections.ArrayList

    Write-Host "Getting files in $SearchRoot..."

    $FilePatterns | ForEach-Object {
        Get-ChildItem -Path $SearchRoot -Filter $_ -Recurse | ForEach-Object {
            $files.Add( $_ ) | Out-Null
        }
    }

    Write-Host "Files found: $($files.Count)"

    If( $files.Count ){
        
        Write-Host "Dumping files..."

        $map = $files | ForEach-Object -Begin { $i = 0 } -Process {
            $i++;
            Write-Host "- Dumping file: $i/$($files.Count)"
            @{
                "File" = $_.FullName
                "Content" = Get-Content -Path $_.FullName -Raw
            }
        }

        Write-Host "Performing regex search..."

        $parsed_regex = [regex]::new($Regex)

        $Out = @{}

        $map | ForEach-Object -Begin { $i = 0 } -Process {
            $i++;
            Write-Host "- Searching file: $i/$($map.Count)"

            $_map = $_

            $m = $parsed_regex.Matches( $_map.Content )
            
            If( $m.Count ){

                $Out[$_map.File] = @{
                    "File" = $_map.File
                    "Content" = $_map.Content
                    "Matches" = $m
                }
            }
        }

        Write-Host "Search completed."

        $Out
    }
}
```

This will generate a mapping of files that contain the `NODE_BINDING_CONTEXT_AWARE_INTERNAL()` to its matches. We can then use this to generate a mapping of each binding to a list of files that declare it.

```powershell
$bindings = & {
    $results = Search-SourceFiles

    # Create a value for tracking the bindings call
    $results.Values | ForEach-Object {
        $result = $_

        $result.Binding = $result.Matches | ForEach-Object {
            @{
                "Name" = $_.Groups[1].Value
                "Register" = $_.Groups[2].Value
            }
        }
    }

    # Create a mapping of bindings to files unordered
    $unordered = @{}

    $results.Values | ForEach-Object {
        $result = $_

        $result.Bindings | ForEach-Object {
            If( -not $unordered.ContainsKey( $_.Name ) ){
                $unordered[$_.Name] = @{}
            }

            $unordered[$_.Name][$result.File] = $result
        }
    }

    # Order the mapping
    $ordered = [ordered]@{}

    $unordered.Keys | Sort-Object | ForEach-Object {
        $key = $_

        $ordered[$key] = $unordered[$key]
    }

    $ordered
}

# Dump our results

$bindings.GetEnumerator() | ForEach-Object {
    $binding = $_.Key

    Write-Host "Internal Binding: " -NoNewLine; Write-Host $binding -ForegroundColor Magenta -NoNewLine; Write-Host;

    $_.Value.GetEnumerator() | ForEach-Object {
        $file = $_.Key
        $mapping = $_.Value.Bindings
        Write-Host "- File: " -NoNewLine -ForegroundColor DarkGray; Write-Host $file -ForegroundColor Cyan -NoNewLine; Write-Host;
        $mapping | ForEach-Object {
            Write-Host "- Register: " -NoNewLine -ForegroundColor DarkGray; Write-Host $_.Register -ForegroundColor Yellow -NoNewLine; Write-Host;
        }
    }

    Write-Host
}
```

```
Internal Binding: async_wrap
- File: S:\ClearScriptBridged\node\src\async_wrap.cc
- Register: node::AsyncWrap::CreatePerContextProperties

Internal Binding: blob
- File: S:\ClearScriptBridged\node\src\node_blob.cc
- Register: node::Blob::CreatePerContextProperties

Internal Binding: block_list
- File: S:\ClearScriptBridged\node\src\node_sockaddr.cc
- Register: node::SocketAddressBlockListWrap::Initialize

Internal Binding: buffer
- File: S:\ClearScriptBridged\node\src\node_buffer.cc
- Register: node::Buffer::Initialize

Internal Binding: builtins
- File: S:\ClearScriptBridged\node\src\node_builtins.cc
- Register: node::builtins::BuiltinLoader::CreatePerContextProperties

Internal Binding: cares_wrap
- File: S:\ClearScriptBridged\node\src\cares_wrap.cc
- Register: node::cares_wrap::Initialize

Internal Binding: config
- File: S:\ClearScriptBridged\node\src\node_config.cc
- Register: node::Initialize

Internal Binding: constants
- File: S:\ClearScriptBridged\node\src\node_constants.cc
- Register: node::constants::CreatePerContextProperties

Internal Binding: contextify
- File: S:\ClearScriptBridged\node\src\node_contextify.cc
- Register: node::contextify::CreatePerContextProperties

Internal Binding: credentials
- File: S:\ClearScriptBridged\node\src\node_credentials.cc
- Register: node::credentials::Initialize

Internal Binding: crypto
- File: S:\ClearScriptBridged\node\src\node_crypto.cc
- Register: node::crypto::Initialize

Internal Binding: encoding_binding
- File: S:\ClearScriptBridged\node\src\encoding_binding.cc
- Register: node::encoding_binding::BindingData::CreatePerContextProperties

Internal Binding: errors
- File: S:\ClearScriptBridged\node\src\node_errors.cc
- Register: node::errors::Initialize

Internal Binding: fs
- File: S:\ClearScriptBridged\node\src\node_file.cc
- Register: node::fs::CreatePerContextProperties

Internal Binding: fs_dir
- File: S:\ClearScriptBridged\node\src\node_dir.cc
- Register: node::fs_dir::CreatePerContextProperties

Internal Binding: fs_event_wrap
- File: S:\ClearScriptBridged\node\src\fs_event_wrap.cc
- Register: node::FSEventWrap::Initialize

Internal Binding: heap_utils
- File: S:\ClearScriptBridged\node\src\heap_utils.cc
- Register: node::heap::Initialize

Internal Binding: http_parser
- File: S:\ClearScriptBridged\node\src\node_http_parser.cc
- Register: node::InitializeHttpParser

Internal Binding: http2
- File: S:\ClearScriptBridged\node\src\node_http2.cc
- Register: node::http2::Initialize

Internal Binding: icu
- File: S:\ClearScriptBridged\node\src\node_i18n.cc
- Register: node::i18n::CreatePerContextProperties

Internal Binding: inspector
- File: S:\ClearScriptBridged\node\src\inspector_js_api.cc
- Register: node::inspector::Initialize
- File: S:\ClearScriptBridged\node\src\node.cc
- Register: Initialize

Internal Binding: internal_only_v8
- File: S:\ClearScriptBridged\node\src\internal_only_v8.cc
- Register: node::internal_only_v8::Initialize

Internal Binding: js_stream
- File: S:\ClearScriptBridged\node\src\js_stream.cc
- Register: node::JSStream::Initialize

Internal Binding: js_udp_wrap
- File: S:\ClearScriptBridged\node\src\js_udp_wrap.cc
- Register: node::JSUDPWrap::Initialize

Internal Binding: messaging
- File: S:\ClearScriptBridged\node\src\node_messaging.cc
- Register: node::worker::CreatePerContextProperties

Internal Binding: mksnapshot
- File: S:\ClearScriptBridged\node\src\node_snapshotable.cc
- Register: node::mksnapshot::CreatePerContextProperties

Internal Binding: module_wrap
- File: S:\ClearScriptBridged\node\src\module_wrap.cc
- Register: node::loader::ModuleWrap::CreatePerContextProperties

Internal Binding: modules
- File: S:\ClearScriptBridged\node\src\node_modules.cc
- Register: node::modules::BindingData::CreatePerContextProperties

Internal Binding: options
- File: S:\ClearScriptBridged\node\src\node_options.cc
- Register: node::options_parser::Initialize

Internal Binding: os
- File: S:\ClearScriptBridged\node\src\node_os.cc
- Register: node::os::Initialize

Internal Binding: performance
- File: S:\ClearScriptBridged\node\src\node_perf.cc
- Register: node::performance::CreatePerContextProperties

Internal Binding: permission
- File: S:\ClearScriptBridged\node\src\permission\permission.cc
- Register: node::permission::Initialize

Internal Binding: pipe_wrap
- File: S:\ClearScriptBridged\node\src\pipe_wrap.cc
- Register: node::PipeWrap::Initialize

Internal Binding: process_methods
- File: S:\ClearScriptBridged\node\src\node_process_methods.cc
- Register: node::process::CreatePerContextProperties

Internal Binding: process_wrap
- File: S:\ClearScriptBridged\node\src\process_wrap.cc
- Register: node::ProcessWrap::Initialize

Internal Binding: profiler
- File: S:\ClearScriptBridged\node\src\inspector_profiler.cc
- Register: node::profiler::Initialize

Internal Binding: quic
- File: S:\ClearScriptBridged\node\src\quic\quic.cc
- Register: node::quic::CreatePerContextProperties

Internal Binding: report
- File: S:\ClearScriptBridged\node\src\node_report_module.cc
- Register: node::report::Initialize

Internal Binding: sea
- File: S:\ClearScriptBridged\node\src\node_sea.cc
- Register: node::sea::Initialize

Internal Binding: serdes
- File: S:\ClearScriptBridged\node\src\node_serdes.cc
- Register: node::serdes::Initialize

Internal Binding: signal_wrap
- File: S:\ClearScriptBridged\node\src\signal_wrap.cc
- Register: node::SignalWrap::Initialize

Internal Binding: spawn_sync
- File: S:\ClearScriptBridged\node\src\spawn_sync.cc
- Register: node::SyncProcessRunner::Initialize

Internal Binding: stream_pipe
- File: S:\ClearScriptBridged\node\src\stream_pipe.cc
- Register: node::InitializeStreamPipe

Internal Binding: stream_wrap
- File: S:\ClearScriptBridged\node\src\stream_wrap.cc
- Register: node::LibuvStreamWrap::Initialize

Internal Binding: string_decoder
- File: S:\ClearScriptBridged\node\src\string_decoder.cc
- Register: node::InitializeStringDecoder

Internal Binding: symbols
- File: S:\ClearScriptBridged\node\src\node_symbols.cc
- Register: node::symbols::Initialize

Internal Binding: task_queue
- File: S:\ClearScriptBridged\node\src\node_task_queue.cc
- Register: node::task_queue::Initialize

Internal Binding: tcp_wrap
- File: S:\ClearScriptBridged\node\src\tcp_wrap.cc
- Register: node::TCPWrap::Initialize

Internal Binding: timers
- File: S:\ClearScriptBridged\node\src\timers.cc
- Register: node::timers::BindingData::CreatePerContextProperties

Internal Binding: tls_wrap
- File: S:\ClearScriptBridged\node\src\crypto\crypto_tls.cc
- Register: node::crypto::TLSWrap::Initialize

Internal Binding: trace_events
- File: S:\ClearScriptBridged\node\src\node_trace_events.cc
- Register: node::NodeCategorySet::Initialize

Internal Binding: tty_wrap
- File: S:\ClearScriptBridged\node\src\tty_wrap.cc
- Register: node::TTYWrap::Initialize

Internal Binding: types
- File: S:\ClearScriptBridged\node\src\node_types.cc
- Register: node::InitializeTypes

Internal Binding: udp_wrap
- File: S:\ClearScriptBridged\node\src\udp_wrap.cc
- Register: node::UDPWrap::Initialize

Internal Binding: url
- File: S:\ClearScriptBridged\node\src\node_url.cc
- Register: node::url::BindingData::CreatePerContextProperties

Internal Binding: util
- File: S:\ClearScriptBridged\node\src\node_util.cc
- Register: node::util::Initialize

Internal Binding: uv
- File: S:\ClearScriptBridged\node\src\uv.cc
- Register: node::uv::Initialize

Internal Binding: v8
- File: S:\ClearScriptBridged\node\src\node_v8.cc
- Register: node::v8_utils::Initialize

Internal Binding: wasi
- File: S:\ClearScriptBridged\node\src\node_wasi.cc
- Register: node::wasi::InitializePreview1

Internal Binding: wasm_web_api
- File: S:\ClearScriptBridged\node\src\node_wasm_web_api.cc
- Register: node::wasm_web_api::Initialize

Internal Binding: watchdog
- File: S:\ClearScriptBridged\node\src\node_watchdog.cc
- Register: node::watchdog::Initialize

Internal Binding: webstorage
- File: S:\ClearScriptBridged\node\src\node_webstorage.cc
- Register: node::webstorage::Initialize

Internal Binding: worker
- File: S:\ClearScriptBridged\node\src\node_worker.cc
- Register: node::worker::CreateWorkerPerContextProperties

Internal Binding: zlib
- File: S:\ClearScriptBridged\node\src\node_zlib.cc
- Register: node::Initialize
```